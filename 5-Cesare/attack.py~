import socket
import sys
from string import ascii_lowercase
import brute_force


# USE   marco@marco-Aspire-V5-571G:~ attack.py PORT IP_GIULIO

if __name__ == '__main__':

    if len(sys.argv) != 3:
		sys.exit('ERROR, usage: python attack.py PORT IP_GIULIO')

    HOST = ''
    PORT = int(sys.argv[1])
    print PORT
    IP_GIULIO = sys.argv[2]

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_address = (HOST, PORT)
    sock.bind(server_address)
    
    sock.listen(3)

    while True:

        print 'Waiting incoming connections...'
        connection, addr = sock.accept()        
        print 'Connected with ' + addr[0] + ':' + str(addr[1])
        #file = open("/home/marco/Python/message_crypted.txt", 'w+');
        file = open("message_crypted.txt", 'w+');
        l = connection.recv(128)

        while (l):
            file.write(l)
            l = connection.recv(128)
          
            
        file.close();
        print("File saved in folder. \n Stopping connection..")
        connection.close()
        sock.close()


        print("Sending file to Giulio..")
        #file = open("/home/marco/Python/message_crypted.txt", 'r+'); 
        file = open("message_crypted.txt", 'r+'); 
        str = file.read(512)
        print ("Connecting to Giulio..")
        sock_send = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        address = (IP_GIULIO,PORT)
        sock_send.connect(address);
        print ("Connected to Giulio , sending file..")

        try:
            sock_send.write(str);
            print ("ok")
        finally:
            sock_send.close()

        #key = brute_force.find_key("/home/marco/Python/message_crypted.txt")
        key = brute_force.find_key("message_crypted.txt")
        print "\nThe key is : \n"
        print key        
        print("\n END");
